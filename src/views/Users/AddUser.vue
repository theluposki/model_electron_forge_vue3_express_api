<script setup>
import { onMounted, ref } from "vue";
import { Emitter } from "../../utils/Emitter.js";
import { generatePassword } from "../../utils/generatePassword.js";
import { api } from "../../axios.js";
import { showNotification } from "../../components/Layout/NotificationService.js";

const showIcon = ref(true);
const lock = ref(true);

const keepAliveAddUser = "keepAliveAddUser";

const autorizacoes = ref([
  {
    id: 1,
    nome: "basic",
  },
  {
    id: 2,
    nome: "administrator",
  },
]);

const newUser = ref({
  nome: null,
  email: null,
  dataNascimento: null,
  autorizacao: "",
  senha: null,
  uploadedImage: null,
});

const viewLock = () => {
  const passEl = document.getElementById("senha");

  if (passEl.type === "password") {
    passEl.type = "text";
    lock.value = false;
    return;
  }
  passEl.type = "password";
  lock.value = true;
};

const generatePassLocal = () => {
  const passEl = document.getElementById("senha");
  lock.value = false;
  passEl.type = "text";
  newUser.value.senha = generatePassword();
};

onMounted(async () => {
  Emitter.emit("route-name", "Adicionar novo usuário");
  Emitter.emit("disable-search");

  if (localStorage.getItem(keepAliveAddUser)) {
    const userLocal = localStorage.getItem(keepAliveAddUser);

    newUser.value = JSON.parse(userLocal);

    if (newUser.value.uploadedImage) {
      document.querySelector(
        ".panel-img"
      ).style.backgroundImage = `url(${newUser.value.uploadedImage})`;

      showIcon.value = false;
    }
  }
});

let saveLocalTimeout;

const keepAlive = () => {
  clearTimeout(saveLocalTimeout);
  saveLocalTimeout = setTimeout(() => {
    localStorage.setItem("keepAliveAddUser", JSON.stringify(newUser.value));
  }, 2000);
};

const clear = () => {
  newUser.value = {
    nome: null,
    email: null,
    dataNascimento: null,
    autorizacao: "",
    senha: null,
    uploadedImage: null,
  };

  localStorage.removeItem(keepAliveAddUser);

  if (newUser.value.uploadedImage === null) {
    document.querySelector(".panel-img").style.backgroundImage = "none";
    showIcon.value = true;
  }
};

const imageUpload = (event) => {
  const input = event.target;
  const file = input.files[0];
  const reader = new FileReader();

  reader.onload = function () {
    const img = new Image();
    img.src = reader.result;

    const updateUI = (imageType, imageBase64, uiClass) => {
      newUser.value.uploadedImage = `data:${imageType};base64,${imageBase64}`;

      document.querySelector(
        uiClass
      ).style.backgroundImage = `url(${newUser.value.uploadedImage})`;

      showIcon.value = false;
      keepAlive();
    };

    img.onload = function () {
      const imageType = file.type;

      const canvas = document.createElement("canvas");
      const ctx = canvas.getContext("2d");

      const maxWidth = 800;
      const maxHeight = 600;
      let newWidth = img.width;
      let newHeight = img.height;

      if (img.width > maxWidth) {
        newWidth = maxWidth;
        newHeight = (img.height * maxWidth) / img.width;
      }

      if (newHeight > maxHeight) {
        newHeight = maxHeight;
        newWidth = (img.width * maxHeight) / img.height;
      }

      canvas.width = newWidth;
      canvas.height = newHeight;

      ctx.drawImage(img, 0, 0, newWidth, newHeight);

      const imageBase64 = canvas.toDataURL(imageType).split(",")[1];

      updateUI(
        imageType,
        imageBase64,
        ".panel-img"
      );
    };
  };

  if (file) {
    reader.readAsDataURL(file);
  }
};

const registerUser = async () => {
  if (
    !newUser.value.nome ||
    !newUser.value.email ||
    !newUser.value.uploadedImage ||
    !newUser.value.dataNascimento ||
    !newUser.value.senha ||
    !newUser.value.autorizacao
  )
    return;

  try {
    const response = await api.post(`/users`, {
      nome: newUser.value.nome,
      email: newUser.value.email,
      imagem: newUser.value.uploadedImage,
      senha: newUser.value.senha,
      data_nascimento: newUser.value.dataNascimento,
      autorizacao: [newUser.value.autorizacao],
    });

    const { message } = response.data;

    showNotification(message, "success");
    clear();
  } catch (error) {
    if (error.response) {
      const data = error.response.data;
      console.log(data);
      showNotification(error.response.data.error, "error");
    }
  }
};
</script>
<template>
  <div class="page-i">
    <div class="form-group">
      <div class="form-control">
        <label for="imageUpload" class="panel-img">
          <i
            class="ri-image-line"
            :style="{ display: showIcon ? 'block' : 'none' }"
          ></i>
          <input
            type="file"
            @change="imageUpload"
            name="upload"
            id="imageUpload"
            accept="image/*"
            hidden
          />
        </label>
      </div>
    </div>

    <div class="form-control">
      <label for="nome"><sup>*</sup>Nome:</label>
      <input
        type="text"
        tabindex="1"
        @keypress="keepAlive"
        id="nome"
        class="input"
        v-model="newUser.nome"
        placeholder="digite o nome"
      />
    </div>

    <div class="form-control">
      <label for="email"><sup>*</sup>E-mail:</label>
      <input
        type="text"
        tabindex="2"
        @keypress="keepAlive"
        id="email"
        class="input"
        v-model="newUser.email"
        placeholder="digite o e-mail"
      />
    </div>

    <div class="form-control">
      <label for="dataNascimento"><sup>*</sup>Data de nascimento:</label>
      <input
        type="date"
        tabindex="3"
        @keypress="keepAlive"
        id="dataNascimento"
        class="input"
        v-model="newUser.dataNascimento"
      />
    </div>

    <div class="form-control">
      <label for="senha"><sup>*</sup>Senha:</label>
      <div class="form-group">
        <input
          type="password"
          tabindex="4"
          @keypress="keepAlive"
          id="senha"
          class="input"
          placeholder="digite a senha"
          v-model="newUser.senha"
        />
        <button class="btn" @click="viewLock">
          <i class="ri-lock-password-line" v-if="lock"></i>
          <i class="ri-lock-unlock-line" v-else></i>
        </button>
        <button class="btn btn-large" @click="generatePassLocal">
          <i class="ri-key-line"></i> Gerar senha
        </button>
      </div>
    </div>

    <div class="form-control">
      <label for="autorizacao"
        ><sup>*</sup>Autorização: {{ newUser.autorizacao }}</label
      >
      <select
        class="select"
        name="autorizacao"
        v-model="newUser.autorizacao"
        id="autorizacao"
        tabindex="5"
        @change="keepAlive"
      >
        <option value="" disabled>Selecione a autorização</option>
        <option v-for="item in autorizacoes" :key="item.id" :value="item.nome">
          {{ item.nome }}
        </option>
      </select>
    </div>

    <div class="form-group space-between mt-40 mb-40 mh-4">
      <button class="btn btn-large muted" @click="clear">Limpar</button>
      <button class="btn btn-large primary" tabindex="6" @click="registerUser">
        Adicionar
      </button>
    </div>
  </div>
</template>

<style scoped>
.panel-img {
  flex: 1;
  min-width: 150px;
  max-width: 150px;
  max-height: 150px;
  min-height: 150px;

  border-radius: 6px;
  background-color: var(--white2);
  box-shadow: rgba(99, 99, 99, 0.2) 0px 2px 8px 0px;

  display: flex;
  align-items: center;
  justify-content: center;

  background-size: cover;
  background-position: center;

  cursor: pointer;
}

.panel-img:hover {
  transition: background-color ease 0.4s;
  background-color: var(--white3);
}

.panel-img:active {
  scale: 0.97;
}

.panel-img > i {
  font-size: 5rem;
  color: var(--silver);
}
</style>
